name: Sync Architecture Docs

on:
    push:
        branches: ["main"]
        paths:
            - "services/**/*.py"

jobs:
    sync-docs:
        runs-on: ubuntu-latest

        permissions:
            contents: write  # needed to push the updated doc back

        steps:
            - uses: actions/checkout@v3
              with:
                  # Fetch full history so the commit author info is available
                  fetch-depth: 0
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Set up Python 3.10
              uses: actions/setup-python@v4
              with:
                  python-version: "3.10"

            - name: Run architecture sync
              id: sync
              run: |
                  python scripts/sync_architecture.py
                  # Exit code 1 means the doc was updated (not an error)
                  echo "exit_code=$?" >> "$GITHUB_OUTPUT"
              continue-on-error: true

            - name: Commit updated docs
              if: steps.sync.outputs.exit_code == '1'
              run: |
                  git config user.name  "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git add docs/ARCHITECTURE.md
                  git diff --staged --quiet || git commit -m \
                      "docs: auto-sync ARCHITECTURE.md from service code changes [skip ci]"
                  git push

            - name: No changes
              if: steps.sync.outputs.exit_code == '0'
              run: echo "ARCHITECTURE.md is already in sync â€” nothing to commit."
